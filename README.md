# üöÄ Intrastat Asistent - Refaktorovan√° Verzia

## üìã Prehƒæad

Kompletne refaktorovan√° verzia Intrastat Asistenta s modul√°rnou architekt√∫rou, roz≈°√≠ren√Ωm error handlingom, professional logging syst√©mom a pokroƒçil√Ωmi funkciami.

### ‚ú® Nov√© Funkcie v Refaktorovanej Verzii

- üèóÔ∏è **Modul√°rna architekt√∫ra** - rozdelenie do logick√Ωch komponentov
- üìä **Professional logging** s rot√°ciou s√∫borov a detailn√Ωmi metrikami
- ‚ö° **Progress tracking** s real-time feedback
- üõ°Ô∏è **Robustn√© error handling** s custom exception hierarchy
- ‚öôÔ∏è **Centralizovan√© nastavenia** cez environment variables
- üîÑ **Rate limiting** pre AI API volania
- üìà **Processing metrics** a ≈°tatistiky
- üéØ **Valid√°cia vstupov** na v≈°etk√Ωch √∫rovniach
- üîç **Data validation** pre CSV s√∫bory
- üé® **Vylep≈°en√© u≈æ√≠vateƒæsk√© rozhranie** s emoji a progress bars

## üìÅ Nov√° ≈†trukt√∫ra Projektu

```
intrastatJablotron/
‚îú‚îÄ‚îÄ data/                          # üì¶ Vstupn√© d√°ta (napr. CSV s k√≥dmi, hmotnos≈•ami)
‚îú‚îÄ‚îÄ data_output/                   # üì§ V√Ωstupn√© CSV reporty
‚îú‚îÄ‚îÄ data_output_archiv/            # üóÑÔ∏è Arch√≠v star≈°√≠ch CSV reportov
‚îú‚îÄ‚îÄ dovozy/                        # ‚úàÔ∏è D√°ta pre dovozn√© fakt√∫ry (ak sa pou≈æ√≠va)
‚îú‚îÄ‚îÄ faktury_na_spracovanie/        # üì• PDF fakt√∫ry ƒçakaj√∫ce na spracovanie
‚îú‚îÄ‚îÄ logs/                          # üìã Log s√∫bory aplik√°cie (auto-vytvoren√©)
‚îú‚îÄ‚îÄ pdf_images/                    # üñºÔ∏è Doƒçasn√© obr√°zky z PDF (pre AI anal√Ωzu)
‚îú‚îÄ‚îÄ spracovane_faktury/            # ‚úÖ PDF fakt√∫ry, ktor√© u≈æ boli spracovan√©
‚îú‚îÄ‚îÄ src/                           # üèóÔ∏è Hlavn√Ω source k√≥d aplik√°cie
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py                # üì¶ Inicializ√°cia src bal√≠ka
‚îÇ   ‚îú‚îÄ‚îÄ report.py                  # üìÑ Generovanie s√∫hrnn√Ωch CSV reportov
‚îÇ   ‚îú‚îÄ‚îÄ config.py                  # ‚öôÔ∏è Centr√°lne nastavenia a konfigur√°cia
‚îÇ   ‚îú‚îÄ‚îÄ models/                    # üß† Business logic a d√°tov√© modely
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py            # üì¶ Inicializ√°cia models bal√≠ka
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ai_analyzer.py         # ü§ñ Spr√°va AI modelov a API volan√≠
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ pdf_processor.py       # üìÑ Spracovanie PDF, konverzia na obr√°zky
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ invoice_processor.py   # üéØ Orchestr√°cia spracovania fakt√∫r
‚îÇ   ‚îú‚îÄ‚îÄ data/                      # üíæ Moduly pre naƒç√≠tanie a spr√°vu d√°t
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py            # üì¶ Inicializ√°cia data bal√≠ka
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ csv_loader.py          # üìä Naƒç√≠tanie d√°t z CSV s√∫borov
‚îÇ   ‚îî‚îÄ‚îÄ utils/                     # üõ†Ô∏è Pomocn√© funkcie a utility
‚îÇ       ‚îú‚îÄ‚îÄ __init__.py            # üì¶ Inicializ√°cia utils bal√≠ka
‚îÇ       ‚îú‚îÄ‚îÄ exceptions.py          # ‚ö†Ô∏è Defin√≠cie vlastn√Ωch v√Ωnimiek
‚îÇ       ‚îú‚îÄ‚îÄ validators.py          # ‚úÖ Funkcie pre valid√°ciu d√°t
‚îÇ       ‚îî‚îÄ‚îÄ logging_config.py      # üìù Konfigur√°cia logovacieho syst√©mu
‚îú‚îÄ‚îÄ .env                           # üîë Lok√°lne konfiguraƒçn√© premenn√© (GIT IGNORED)
‚îú‚îÄ‚îÄ .env.example                   #  üìÑ Pr√≠klad .env s√∫boru
‚îú‚îÄ‚îÄ .gitignore                     # üö´ ≈†pecifik√°cia ignorovan√Ωch s√∫borov Gitom
‚îú‚îÄ‚îÄ environment.yml                # üêç Z√°vislosti projektu pre Conda prostredie
‚îú‚îÄ‚îÄ LICENSE                        # üìú Licencia projektu
‚îú‚îÄ‚îÄ main.py                        # ‚ñ∂Ô∏è Hlavn√Ω sp√∫≈°≈•ac√≠ skript aplik√°cie
‚îî‚îÄ‚îÄ README.md                      # üìñ T√°to dokument√°cia
```

## üöÄ Quick Start

### 1. In≈°tal√°cia Dependencies

```bash
pip install -r requirements.txt
```

### 2. Konfigur√°cia Environment Variables

Vytvorte `.env` s√∫bor:

```bash
# Povinn√©
GOOGLE_API_KEY=your_gemini_api_key_here

# Voliteƒæn√© (s default hodnotami)
PDF_DPI=200
MAX_RETRIES=3
BATCH_SIZE=5
LOG_LEVEL=INFO
```

### 3. Spustenie

```bash
python main.py
```

### 4. V√Ωber z Menu

```
==================================================
        INTRASTAT ASISTENT MENU
==================================================
1. üìÑ Spracova≈• nov√© PDF fakt√∫ry
2. üìä Generova≈• s√∫hrnn√Ω report z CSV
3. üè∑Ô∏è  Zobrazi≈• coln√© k√≥dy
6. ‚ùå Ukonƒçi≈•
==================================================
```

## üèóÔ∏è Architekt√∫ra

### Core Components

#### üéØ InvoiceProcessor
Hlavn√Ω orchestr√°tor cel√©ho workflow:
- Koordinuje v≈°etky komponenty
- Progress tracking s tqdm
- Metrics collection
- Error recovery

#### ü§ñ GeminiAnalyzer
AI management s pokroƒçil√Ωmi funkciami:
- Rate limiting pre API volania
- Connection pooling
- Response parsing s error handling
- Custom prompts pre r√¥zne √∫lohy

#### üìÑ PDFProcessor
Memory-efficient PDF spracovanie:
- Generator-based processing
- Image cleanup utilities
- PDF metadata extraction
- Configurable DPI settings

#### üíæ DataManager
Centralizovan√© d√°tov√© oper√°cie:
- Cached CSV loaders
- Data validation
- Error reporting
- BOM handling

### üõ°Ô∏è Error Handling System

```python
# Custom exception hierarchy
IntrastatError
‚îú‚îÄ‚îÄ ConfigurationError      # Konfiguraƒçn√© chyby
‚îú‚îÄ‚îÄ PDFProcessingError      # PDF konverzia a spracovanie
‚îú‚îÄ‚îÄ AIAnalysisError         # AI API a response handling
‚îú‚îÄ‚îÄ DataValidationError     # Input validation
‚îú‚îÄ‚îÄ CSVProcessingError      # CSV oper√°cie
‚îú‚îÄ‚îÄ WeightCalculationError  # Hmotnostn√© v√Ωpoƒçty
‚îú‚îÄ‚îÄ CustomsCodeError        # Coln√© k√≥dy
‚îú‚îÄ‚îÄ FileOperationError      # S√∫borov√© oper√°cie
‚îî‚îÄ‚îÄ RateLimitExceededError  # API rate limiting
```

### üìä Logging System

```python
# Hierarchick√© logging s rot√°ciou
logs/
‚îú‚îÄ‚îÄ intrastat.log          # V≈°etky logy (max 10MB, 5 backups)
‚îî‚îÄ‚îÄ errors.log             # Iba errors (max 5MB, 3 backups)

# Log levels: DEBUG, INFO, WARNING, ERROR, CRITICAL
# UTF-8 encoding support
# Timestamp + Module + Level + Message format
```

### ‚öôÔ∏è Configuration Management

```python
# AppSettings dataclass s environment support
@dataclass
class AppSettings:
    google_api_key: str = os.getenv("GOOGLE_API_KEY")
    pdf_dpi: int = int(os.getenv("PDF_DPI", "200"))
    max_retries: int = int(os.getenv("MAX_RETRIES", "3"))
    # ... a ƒèal≈°ie nastavenia
    
    def validate(self) -> None:
        # Valid√°cia v≈°etk√Ωch nastaven√≠
    
    def ensure_directories(self) -> None:
        # Vytvorenie potrebn√Ωch adres√°rov
```

## üìà Performance Optimizations

### üîÑ Rate Limiting
```python
@rate_limit(calls_per_minute=30)
def ai_api_call(self, ...):
    # Automatick√© rate limiting pre AI volania
```

### üíæ Memory Management
```python
def pdf_to_images_generator(self, pdf_path):
    # Generator pattern pre memory-efficient processing
    for page_num in range(total_pages):
        yield process_page(page_num)
        # Automatick√© uvoƒænenie pam√§te
```

### üè™ Caching
```python
class DataManager:
    def get_product_weights(self, force_reload=False):
        if self._weights_cache is None or force_reload:
            self._weights_cache = self.weight_loader.load_weights()
        return self._weights_cache
```

## üîç Monitoring & Metrics

### üìä Processing Metrics
```python
class ProcessingMetrics:
    - processed_pdfs: int           # √öspe≈°ne spracovan√©
    - failed_pdfs: int             # Ne√∫spe≈°n√©
    - ai_api_calls: int            # Poƒçet AI volan√≠
    - processing_time: float       # Celkov√Ω ƒças
    - success_rate_percent: float  # √öspe≈°nos≈• %
    - avg_time_per_pdf: float      # Priemern√Ω ƒças na PDF
```

### üìã Data Validation Reports
```python
validation_results = {
    "product_weights": True/False,
    "customs_codes": True/False
}
# Detailn√© error reporting pre ka≈æd√Ω s√∫bor
```

## üõ†Ô∏è Advanced Features

### üéØ Smart Input Validation
```python
# Valid√°cia na v≈°etk√Ωch √∫rovniach
validate_pdf_file(file_path, max_size_mb=50)
validate_country_code("SK")  # ISO 3166-1 alpha-2
validate_customs_code("85311030")  # 8-digit format
validate_weight("123,45")  # Slovak decimal format support
```

### ü§ñ Enhanced AI Prompts
- ≈†pecializovan√© prompty pre invoice analysis
- Pokroƒçil√© customs code assignment s context
- Weight adjustment s precision targeting
- Hardcoded overrides pre ≈°pecifick√© produkty

### üìä Progress Tracking
```python
# Real-time progress s tqdm
with tqdm(total=len(pdf_files), desc="Spracov√°vam PDF") as pbar:
    for pdf_file in pdf_files:
        pbar.set_description(f"Spracov√°vam: {pdf_file}")
        # processing...
        pbar.update(1)
```

## üîß Migration Guide

### Z P√¥vodnej Verzie na Refaktorovan√∫

1. **Backup d√°t**:
   ```bash
   cp -r data_output/ data_output_backup/
   cp -r spracovane_faktury/ spracovane_faktury_backup/
   ```

2. **Environment setup**:
   ```bash
   # Vytvorte .env s√∫bor s API kƒæ√∫ƒçom
   echo "GOOGLE_API_KEY=your_key_here" > .env
   ```

3. **Testovanie**:
   ```bash
   # Pou≈æite mal√Ω test PDF najprv
   python main_new.py
   ```

4. **Postupn√° migr√°cia**:
   - Refaktorovan√° verzia je plne kompatibiln√° s existuj√∫cimi d√°tami
   - P√¥vodn√Ω `main.py` zost√°va funkƒçn√Ω pre backward compatibility
   - Postupne pres√∫vajte workflow na `main_new.py`

## üêõ Troubleshooting

### ƒåast√© Probl√©my

1. **Import Error**: `ModuleNotFoundError: No module named 'src'`
   ```bash
   # Rie≈°enie: Spustite z root adres√°ra projektu
   cd /path/to/intrastatJablotron
   python main_new.py
   ```

2. **API Rate Limiting**: `RateLimitExceededError`
   ```bash
   # Rie≈°enie: Nastavte ni≈æ≈°√≠ rate limit v .env
   echo "AI_RATE_LIMIT_PER_MINUTE=20" >> .env
   ```

3. **Memory Issues**: Pri veƒæk√Ωch PDF s√∫boroch
   ```bash
   # Rie≈°enie: Zn√≠≈æte DPI v .env
   echo "PDF_DPI=150" >> .env
   ```

4. **Logging Issues**: Probl√©my s UTF-8
   ```bash
   # Rie≈°enie: Nastavte spr√°vne locale
   export LANG=en_US.UTF-8
   export LC_ALL=en_US.UTF-8
   ```

### üìã Debug Mode

```bash
# Nastavte DEBUG level pre detailn√© logy
echo "LOG_LEVEL=DEBUG" >> .env
python main_new.py

# Skontrolujte logs
tail -f logs/intrastat.log
tail -f logs/errors.log
```

## üéØ Best Practices

### 1. **Environment Management**
```bash
# Pou≈æ√≠vajte .env s√∫bor pre konfigur√°ciu
# Nikdy necommitujte API kƒæ√∫ƒçe do git
echo ".env" >> .gitignore
```

### 2. **Monitoring**
```bash
# Pravidelne kontrolujte logy
tail -f logs/intrastat.log

# Sledujte metrics cez menu option 5
```

### 3. **Data Backup**
```bash
# Pred v√§ƒç≈°√≠mi zmenami backupujte d√°ta
cp -r data_output/ backup_$(date +%Y%m%d)/
```

### 4. **Performance Tuning**
```bash
# Pre veƒæk√© objemy nastavte batch processing
echo "BATCH_SIZE=3" >> .env
echo "AI_RATE_LIMIT_PER_MINUTE=20" >> .env
```

## üöÄ Bud√∫ce Vylep≈°enia

### Pl√°novan√© Features
- üåê **Web Interface** - Django/Flask frontend
- üóÑÔ∏è **Database Integration** - SQLite/PostgreSQL support
- üìä **Advanced Analytics** - dashboards a reporting
- üîÑ **Async Processing** - parallel PDF processing
- üîê **Enhanced Security** - role-based access
- üì± **Mobile Support** - responsive design
- ü§ù **API Integration** - REST API endpoints
- üß™ **Unit Testing** - comprehensive test suite

### Contributions Welcome
- Fork the repository
- Create feature branch: `git checkout -b feature/amazing-feature`
- Commit changes: `git commit -m 'Add amazing feature'`
- Push to branch: `git push origin feature/amazing-feature`
- Open Pull Request

## üìû Support

### Dokument√°cia
- **Audit Report**: `audit.md` - detailn√° anal√Ωza zlep≈°en√≠
- **Original README**: `README.md` - p√¥vodn√° dokument√°cia
- **Config Reference**: `src/config.py` - v≈°etky nastavenia

### Kontakt
- Otvorte GitHub issue pre bugs a feature requests
- Skontrolujte logy pre debugging inform√°cie
- Pou≈æite menu option 4 pre valid√°ciu d√°t

---

## üéâ Z√°ver

Refaktorovan√° verzia predstavuje v√Ωznamn√Ω upgrade v kvalite, maintainability a profesionalite k√≥du. Zachov√°va v≈°etku p√¥vodn√∫ funkcionalitu while adding enterprise-grade features ako logging, metrics, validation, a error handling.

**Hlavn√© benefity:**
- ‚úÖ **Production-ready** k√≥d s professional ≈°tandardmi
- ‚úÖ **Modul√°rna architekt√∫ra** pre jednoduch√© roz≈°√≠renie
- ‚úÖ **Comprehensive error handling** pre robustn√© spracovanie
- ‚úÖ **Performance optimizations** pre ≈°k√°lovateƒænos≈•
- ‚úÖ **Monitoring a metrics** pre operational insight
- ‚úÖ **Backward compatibility** s existuj√∫cimi d√°tami

Zaƒçnite s `python main_new.py` a za≈æite rozdiel! üöÄ 